---
  - name: Task for all
    hosts: all
    become: true
    pre_tasks:
    
    - name: Update cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install traceroute
      apt:
        name: traceroute
        state: present

  - name: Setup internet router
    hosts: inet
    become: true
    tasks:

    - name: Enable port forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
        sysctl_set: yes
        state: present
        reload: yes
    
    - name: Enable masquerade
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: 'enp0s3'
        jump: MASQUERADE

    - name: Enable forwarding trafic
      iptables:
        chain: FORWARD
        in_interface: 'enp0s8'
        out_interface: 'enp0s3'
        jump: ACCEPT
      become: yes

    - name: Enable stateconnect
      iptables:
        chain: FORWARD
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
      become: yes

  - name: Setup central router
    hosts: inter
    become: true
    tasks:

#    - name: Add default route
#      shell:
#        cmd: sudo ip route add default via 192.168.255.1 dev enp0s8

    - name: Enable port forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
        sysctl_set: yes
        state: present
        reload: yes

    - name: Enable masquerade
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: 'enp0s8'
        jump: MASQUERADE

    - name: Enable forwarding trafic
      iptables:
        chain: FORWARD
        in_interface: 'enp0s9'
        out_interface: 'enp0s8'
        jump: ACCEPT
      become: yes

    - name: Enable stateconnect
      iptables:
        chain: FORWARD
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
      become: yes

  - name: Setup central server
    hosts: servers
    become: true
    tasks:

    - name: Add default route
      shell:
        cmd: sudo ip route add default via 192.168.0.1 dev enp0s8

    - name: Install nginx
      apt:
        name: nginx
        state: present

